name: Run Pytest

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  test:
    runs-on: ubuntu-latest
    env:
          typst_ver: "0.13.1"

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest

    - name: Install Typst CLI
      run: |
        sudo apt-get update && \
        sudo apt-get install -y --no-install-recommends curl xz-utils && \
        curl -fL -o /tmp/typst.tar.xz \
          https://github.com/typst/typst/releases/download/v${{ env.typst_ver }}/typst-x86_64-unknown-linux-musl.tar.xz && \
        tar -xf /tmp/typst.tar.xz -C /tmp/ --strip-components=1 && \
        chmod +x /tmp/typst && \
        sudo mv /tmp/typst /usr/local/bin/typst && \
        typst --version && \
        sudo apt-get purge -y curl xz-utils && \
        sudo apt-get autoremove -y && \
        sudo rm -rf /var/lib/apt/lists/* /tmp/typst.tar.xz

    - name: Run tests
      run: pytest
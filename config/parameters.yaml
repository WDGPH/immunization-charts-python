# ==============================================================================
# IMMUNIZATION CHARTS - UNIFIED CONFIGURATION
# ==============================================================================
# This configuration file controls all aspects of the immunization charts
# PDF generation pipeline. Settings are organized to reflect the pipeline
# processing order:
#
# Step 1: Prepare output directory
# Step 2: Preprocessing (data normalization, QR payload setup)
# Step 3: Generate Typst templates
# Step 4: Compile Typst to PDF
# Step 5: Validate PDF page lengths
# Step 6: Encrypt PDFs
# Step 7: Batch PDFs (optional, skipped if encryption enabled)
# Step 8: Cleanup intermediate files
#
# For a minimal configuration that skips batching, comment out or remove the
# batching section entirely.

# ==============================================================================
# GENERAL PIPELINE CONFIGURATION
# ==============================================================================
pipeline:
  # Automatically remove existing output directory contents without prompting
  # Set to true to skip confirmation when output directory already exists
  auto_remove_output: true
  
  # Keep intermediate files after successful pipeline completion
  # Intermediate files include: .typ (Typst source), .json (metadata), per-client .pdf
  keep_intermediate_files: false

# ==============================================================================
# STEP 2: PREPROCESSING CONFIGURATION
# ==============================================================================
# Data normalization and content configuration for immunization notices.

# Used to calculate student age at time of mail delivery
# Students 16 and older can be addressed directly
# Letters for students under 16 should be addressed to their parent/guardian
delivery_date: "2025-04-08"

# Date to display in notice templates (e.g., "August 31, 2025")
date_today: "August 31, 2025"

# Vaccines or agents that should appear in the immunization history chart
chart_diseases_header:
  - Diphtheria
  - Tetanus
  - Pertussis
  - Polio
  - Hib
  - Pneumococcal
  - Rotavirus
  - Measles
  - Mumps
  - Rubella
  - Meningococcal
  - Varicella
  - Other

# Vaccines or agents to ignore/drop from immunization history
ignore_agents:
  - RSVAb
  - VarIg
  - HBIg
  - RabIg
  - Ig

# QR code payload configuration (for notices)
# Configuration for QR code payloads embedded in notices.
#
# The payload_template section allows flexible customization of QR payload
# content through template strings. Templates support Python-style placeholders
# for dynamic value substitution.
#
# Allowed placeholders:
#   - client_id, first_name, last_name, name
#   - date_of_birth, date_of_birth_iso
#   - school, city, postal_code, province, street_address
#   - language, language_code, delivery_date
#
# Example: "https://example.com/update?id={client_id}&dob={date_of_birth_iso}"

qr:
  # Enable or disable QR code generation in notices
  enabled: true

  # QR payload template strings with Python-style placeholders
  # Separate templates for each language
  payload_template:
    en: "https://www.test-immunization.ca/update?client_id={client_id}&dob={date_of_birth_iso}&lang={language_code}"
    fr: "https://www.test-immunization.ca/update?client_id={client_id}&dob={date_of_birth_iso}&lang={language_code}"

# ==============================================================================
# STEP 3-4: TYPST COMPILATION CONFIGURATION
# ==============================================================================
# Configuration for Typst template generation and PDF compilation.
typst:
  # Path to Typst font directory
  # Used for custom font resolution during PDF compilation
  font_path: "/usr/share/fonts/truetype/freefont/"
  
  # Typst executable name or full path
  # Can be overridden via TYPST_BIN environment variable
  bin: "typst"

# ==============================================================================
# STEP 6: PDF ENCRYPTION CONFIGURATION
# ==============================================================================
# Configuration for PDF encryption and password generation.
#
# The password_template section allows flexible customization of PDF password
# generation through template strings. Passwords are generated from client
# metadata by substituting template placeholders with actual values.
#
# Allowed placeholders:
#   - client_id, first_name, last_name, name
#   - date_of_birth, date_of_birth_iso, date_of_birth_iso_compact
#   - school, city, postal_code, province, street_address
#   - language, language_code, delivery_date
#
# Examples:
#   - "{date_of_birth_iso_compact}": Uses DOB in YYYYMMDD format (e.g., "20100515")
#   - "{client_id}{date_of_birth_iso_compact}": Combines ID and DOB
#   - "{first_name}-{date_of_birth_iso}": Combines name and DOB with dash

encryption:
  # Enable or disable PDF encryption processing
  enabled: true

  # Password generation settings using template-based approach
  password:
    # Template string to generate PDF passwords
    # Default: use only DOB in compact format (YYYYMMDD)
    template: "{date_of_birth_iso_compact}"

# ==============================================================================
# STEP 7: BATCHING CONFIGURATION (Optional)
# ==============================================================================
# Configure how per-client PDFs are combined into batches.
# 
# Batching is automatically skipped when encryption is enabled.
# To disable batching entirely, set batch_size to 0 or comment out this section.
#
# Example configurations:
#   - batch_size: 100            # 100 clients per batch, sequential ordering
#   - batch_size: 50, group_by: school   # 50 clients per batch, grouped by school
#   - batch_size: 0              # Disable batching (keep individual PDFs)

batching:
  # Number of clients to include in a single batch/combined PDF
  # Set to 0 or omit to disable batching entirely
  batch_size: 100

  # Group batches by an identifier before chunking
  # Options: null (sequential by client order), "school", "board"
  # null = chunk PDFs in order (default)
  # "school" = group by school_id, then chunk each school's PDFs
  # "board" = group by board_id, then chunk each board's PDFs
  group_by: null

# ==============================================================================
# STEP 8: CLEANUP CONFIGURATION
# ==============================================================================
cleanup:
  # Directories to remove during cleanup phase
  remove_directories:
    - "artifacts"
    - "by_school"
    - "batches"
    - "qr_codes"
  
  # File extensions to remove from legacy directories
  remove_extensions:
    - "typ"
    - "json"
    - "csv"
